<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Editar Nota del Paciente</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
<script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13a4ec",
            "background-light": "#f6f7f8",
            "background-dark": "#101c22",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "1rem",
            "xl": "1.5rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
<div class="relative flex min-h-screen w-full justify-center">
<main class="w-full max-w-7xl p-8">
<div class="flex flex-col gap-8 max-w-4xl mx-auto">
<div class="flex flex-col gap-2">
<a class="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors w-fit" href="VerNotas">
<span class="material-symbols-outlined">arrow_back</span>
<span class="text-sm font-medium">Regresar a Notas y Evolución</span>
</a>
<h1 class="text-slate-900 dark:text-slate-100 text-4xl font-black leading-tight tracking-[-0.033em]">Editar Nota del Paciente</h1>
<p class="text-slate-500 dark:text-slate-400 text-base font-normal leading-normal">Modifique la nota clínica.</p>
</div>
<div class="w-full bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 flex flex-col gap-6">
<div class="flex flex-col gap-1">
<h2 class="text-slate-900 dark:text-slate-100 text-lg font-bold leading-tight">Detalles de la Nota</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-slate-600 dark:text-slate-300">
<p><span class="font-medium text-slate-800 dark:text-slate-200">Paciente:</span> -</p>
<p><span class="font-medium text-slate-800 dark:text-slate-200">Fecha de la nota:</span> -</p>
</div>
</div>
<label class="flex flex-col w-full">
<p class="text-slate-900 dark:text-slate-100 text-base font-medium leading-normal pb-2">Contenido de la Nota</p>
<textarea class="form-textarea w-full min-h-[300px] resize-y rounded-lg text-slate-900 dark:text-slate-100 focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary placeholder:text-slate-400 dark:placeholder:text-slate-500 p-4 text-base font-normal leading-normal" placeholder="Escriba aquí el contenido de la nota clínica..."></textarea>
</label>
<div class="flex justify-end items-center gap-4 mt-4">
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-slate-300 dark:hover:bg-slate-600">
<span class="truncate">Cancelar</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 gap-2">
<span class="material-symbols-outlined text-base">save</span>
<span class="truncate">Guardar Cambios</span>
</button>
</div>
</div>
</div>
</main>
</div>

<script>
// Cargar una nota por ID y permitir guardarla
let idNota = null;
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  idNota = params.get('id');
  if (!idNota) {
    alert('No se indicó ID de nota');
    window.location.href = 'VerNotas';
    return;
  }
  cargarNota();

  const btnGuardar = document.querySelector('button[class*="bg-primary"]');
  const btnCancelar = document.querySelector('button[class*="bg-slate-200"]');
  btnGuardar.addEventListener('click', guardarCambios);
  btnCancelar.addEventListener('click', () => { if (confirm('Cancelar cambios?')) window.location.href = 'VerNotas'; });
});

async function cargarNota() {
  try {
    const res = await fetch(`api_notas.php?action=obtener&id=${idNota}`);
    const j = await res.json();
    if (j.success) {
      const n = j.data;
      const detalles = document.querySelectorAll('.grid p');
      detalles[0].innerHTML = `<span class="font-medium text-slate-800 dark:text-slate-200">Paciente:</span> ${n.Nombre_Paciente}`;
      detalles[1].innerHTML = `<span class="font-medium text-slate-800 dark:text-slate-200">Fecha de la nota:</span> ${formatDate(n.Fecha_Sesion)}`;
      const ta = document.querySelector('textarea');
      ta.value = n.Contenido || '';
      // if there's a date input, create or set it
      let inputDate = document.querySelector('input[type="date"]');
      if (!inputDate) {
        // insert a hidden input for date if needed
        const label = document.createElement('input');
        label.type = 'hidden';
        label.value = n.Fecha_Sesion || '';
        label.id = 'fecha_sesion_hidden';
        document.querySelector('form')?.appendChild(label);
      } else {
        inputDate.value = n.Fecha_Sesion || '';
      }
    } else {
      alert('Error: ' + (j.message||''));
      window.location.href = 'VerNotas';
    }
  } catch (err) { console.error(err); alert('Error de conexión'); }
}

async function guardarCambios() {
  const contenido = document.querySelector('textarea').value.trim();
  if (!contenido) { alert('El contenido no puede estar vacío'); return; }
  let fecha = document.querySelector('input[type="date"]')?.value || document.getElementById('fecha_sesion_hidden')?.value || null;
  const body = { Contenido: contenido, Resumen: contenido.substring(0,255) };
  if (fecha) body.Fecha_Sesion = fecha;

  try {
    const res = await fetch(`api_notas.php?action=actualizar&id=${idNota}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
    });
    const j = await res.json();
    if (j.success) { alert('Nota actualizada'); window.location.href = 'VerNotas'; }
    else alert('Error: ' + (j.message||''));
  } catch (err) { console.error(err); alert('Error de conexión al guardar'); }
}

function formatDate(d) {
  if (!d) return '-';
  const date = new Date(d);
  return date.toLocaleDateString('es-ES');
}

</script>

</body></html>